# name: Build, Push to ECR and Deploy (Helm)

# on:
#   push:
#     branches:
#       - master

# jobs:
#   build-and-push:
#     name: Build and Push to ECR
#     runs-on: ubuntu-latest
#     env:
#       AWS_REGION: ${{ secrets.AWS_REGION }}
#       AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
#       ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Login to Amazon ECR
#         uses: aws-actions/amazon-ecr-login@v1

#       - name: Build, tag and push Docker image
#         env:
#           IMAGE_TAG: ${{ github.sha }}
#           ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
#         run: |
#           IMAGE_NAME=${ECR_REGISTRY}/${{ secrets.ECR_REPOSITORY }}:${IMAGE_TAG}
#           echo "Building $IMAGE_NAME"
#           docker build -t "$IMAGE_NAME" .
#           docker push "$IMAGE_NAME"
#           echo "::set-output name=image::$IMAGE_NAME"

#   deploy:
#     name: Deploy with Helm
#     runs-on: ubuntu-latest
#     needs: build-and-push
#     env:
#       AWS_REGION: ${{ secrets.AWS_REGION }}
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Restore Kubeconfig
#         env:
#           KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
#         run: |
#           echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config

#       - name: Setup Helm
#         uses: azure/setup-helm@v3

#       - name: Deploy Helm chart
#         env:
#           IMAGE_TAG: ${{ github.sha }}
#           ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
#         run: |
#           IMAGE_NAME=${ECR_REGISTRY}/${{ secrets.ECR_REPOSITORY }}:${IMAGE_TAG}
#           helm upgrade --install geargo . -n geargo --create-namespace \
#             --set image.repository=${ECR_REGISTRY}/${{ secrets.ECR_REPOSITORY }} \
#             --set image.tag=${IMAGE_TAG} \
#             --set postgres.enabled=true \
#             --set postgres.password='${{ secrets.POSTGRES_PASSWORD }}'
